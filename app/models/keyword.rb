require 'csv'
require 'mechanize'
class Keyword < ActiveRecord::Base
	belongs_to :user
	serialize :non_ads_urls
	serialize :top_ads_ulrs
	serialize :right_ads_ulrs
	validates_uniqueness_of :title

	before_save :search_keyword

	@@result_stats_element = "#resultStats"
	@@top_position_ads_element = "#tads" 
	@@right_position_ads_element = "#mbEnd"
	@@non_ads_result_element = "#search"


	def self.import(file)
		CSV.foreach(file.path) do |row| 
			Keyword.create(title: row[0])
		end
	end

	def prepare_keyword_title(keyword)
		keyword[0].gsub(/\s+/, "+")
	end 

	def search_keyword
		agent = Mechanize.new
		# This is just for tests purposes
		# stream = File.read("google-ads.htm")
		# FakeWeb.register_uri(:get, "http://www.google.com", :body => stream, :content_type => "text/html")
		# page = agent.get("http://www.google.com")

		page = agent.get("http://www.google.com/search?q=" + prepare_keyword_title(self.title) + "%20&ie=utf-8&oe=utf-8")
		self.result_page = page
		self.total_links = page.links.size
		self.result_stats = page.at(@@result_stats_element).text.strip
		self.top_ads_urls = page.search(@@top_position_ads_element).css(".ads-ad").map { |link| link.css(".ads-visurl cite") }
		self.right_ads_urls = page.search(@@right_position_ads_element).css(".ads-ad").map { |link| link.css(".ads-visurl cite") }
		self.top_ads = self.top_ads_urls.size
		self.right_ads = self.right_ads_urls.size
		self.total_ads = self.top_ads + self.right_ads
		self.non_ads_urls = page.search(@@non_ads_result_element).css(".rc").map { |link| link['href'] }
		self.non_ads_results = self.non_ads_urls.size
	end
end
